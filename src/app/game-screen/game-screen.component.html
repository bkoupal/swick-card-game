<div class="grid place-items-center min-h-full p-4">
  <div class="flex gap-2 place-self-start">
    <button
      mat-mini-fab
      color="primary"
      matTooltip="Leave room"
      (click)="game.room!.leave()"
    >
      <mat-icon>logout</mat-icon>
    </button>

    <button
      mat-mini-fab
      color="primary"
      matTooltip="Copy room link to clipboard"
      [cdkCopyToClipboard]="location.href.split('?')[0]"
    >
      <mat-icon>link</mat-icon>
    </button>

    <!--button
      *ngIf="game.player?.admin"
      mat-mini-fab
      color="primary"
      matTooltip="You are the room's admin"
    >
      <mat-icon>star</mat-icon>
    </button-->

    <!--button
      *ngIf="game.isDealer"
      mat-mini-fab
      color="accent"
      matTooltip="You are the dealer this hand"
    >
      <mat-icon>casino</mat-icon>
    </button-->

    <button
      *ngIf="canChangeName()"
      mat-mini-fab
      color="accent"
      matTooltip="Change your name"
      (click)="openNameChangeDialog()"
      data-cy="change-name-btn"
    >
      <mat-icon>edit</mat-icon>
    </button>
  </div>

  <!-- Enhanced pot display with going set information -->
  <!-- div *ngIf="game.room!.state.potValue > 0" class="table-font mt-1"-->
  <div class="absolute top-4 right-4 table-font z-50">
    <div
      class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold shadow-lg"
    >
      <!-- Main pot value -->
      <div class="text-lg">ğŸ’° Pot: {{ game.room!.state.potValue }}Â¢</div>

      <!-- Show trick values -->
      <div class="text-sm text-green-200 mt-1">
        Each trick: {{ getTrickValue() }}Â¢
      </div>

      <!-- Going set bonus indicator -->
      <div
        *ngIf="getNextRoundBonus() > 0"
        class="text-yellow-400 text-sm mt-1 flex items-center"
      >
        <span class="mr-1">ğŸ’¸</span>
        +{{ getNextRoundBonus() }}Â¢ next round
      </div>

      <!-- Total pot preview for next round -->
      <div *ngIf="getNextRoundBonus() > 0" class="text-green-400 text-xs mt-1">
        (Next pot starts at {{ getNextRoundBonus() + 3 }}Â¢)
      </div>
    </div>
  </div>

  <!-- Privacy Indicator -->

  <!--div class="game-privacy-indicator" *ngIf="game.room?.state?.roomMetadata">
    <mat-chip-set>
      <mat-chip
        [color]="
          game.room?.state?.roomMetadata?.isPublic ? 'primary' : 'accent'
        "
        selected
      >
        <mat-icon>{{
          game.room?.state?.roomMetadata?.isPublic ? "public" : "lock"
        }}</mat-icon>
        {{
          game.room?.state?.roomMetadata?.isPublic
            ? "Public Game"
            : "Private Game"
        }}
      </mat-chip>
    </mat-chip-set>
  </div-->

  <!-- Room ID display for private games -->
  <div
    class="room-id-display"
    *ngIf="
      game.room?.state?.roomMetadata &&
      !game.room?.state?.roomMetadata?.isPublic
    "
  >
    <mat-chip-set>
      <mat-chip color="warn" selected>
        <mat-icon>share</mat-icon>
        Share ID: {{ game.room?.id }}
      </mat-chip>
    </mat-chip-set>
  </div>

  <div class="grid place-items-center py-8 w-min">
    <!-- COMPLETELY CLEAN - NO WIDTH CONSTRAINTS ANYWHERE -->
    <div
      class="absolute left-1/2 transform -translate-x-1/2 z-20"
      style="top: 10%"
    >
      <div
        *ngIf="
          game.room!.state.currentTrick &&
          game.room!.state.currentTrick.length > 0
        "
        class="table-font text-amber-50 font-serif text-center"
      >
        <div class="font-bold mb-2">
          Trick {{ game.room!.state.currentTrickNumber }}
        </div>

        <!-- Top row: Cards 1-4 -->
        <div class="flex justify-center gap-1 mb-2">
          <div
            *ngFor="let playedCard of game.room!.state.currentTrick.slice(0, 4)"
            class="flex flex-col items-center"
          >
            <app-card
              [card]="playedCard.card"
              class="scale-75 sm:scale-75"
            ></app-card>
            <div style="font-size: 8px; margin-top: -8px; text-align: center">
              {{ getPlayerName(playedCard.playerId) }}
            </div>
          </div>
        </div>

        <!-- Bottom row: Cards 5-6 if they exist -->
        <div
          *ngIf="game.room!.state.currentTrick.length > 4"
          class="flex justify-center gap-1"
        >
          <div class="flex flex-col items-center">
            <app-card
              [card]="game.room!.state.currentTrick[4].card"
              class="scale-75 sm:scale-75"
            ></app-card>
            <div style="font-size: 8px; margin-top: -8px; text-align: center">
              {{ getPlayerName(game.room!.state.currentTrick[4].playerId) }}
            </div>
          </div>

          <div
            *ngIf="game.room!.state.currentTrick.length > 5"
            class="flex flex-col items-center"
          >
            <app-card
              [card]="game.room!.state.currentTrick[5].card"
              class="scale-75 sm:scale-75"
            ></app-card>
            <div style="font-size: 8px; margin-top: -8px; text-align: center">
              {{ getPlayerName(game.room!.state.currentTrick[5].playerId) }}
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="player-holder row-start-1 col-start-1">
      <app-player
        *ngFor="let player of getAllPlayers(smallScreen$ | async); index as i"
        [style.z-index]="10 - Math.round(getPlayerPosition(i) * 10)"
        [class.client-player]="game.room!.sessionId === player?.sessionId"
        [player]="player"
        [endTimestamp]="game.roundEndTimestamp"
        [isPlayerTurn]="
          game.room!.state.currentTurnPlayerId === player?.sessionId
        "
        [clientIsPlayer]="game.room!.sessionId === player?.sessionId"
        [scoreBottom]="
          (smallScreen$ | async) ||
          (getPlayerPosition(i) <= 0.25 && getPlayerPosition(i) != 0)
        "
        [isDealer]="player?.sessionId === game.room!.state.dealerId"
        [gameState]="game.room!.state"
        (playCard)="game.playCard($event)"
        (selectCard)="game.selectCard($event)"
        (kick)="game.kick($event)"
      ></app-player>
    </div>

    <div
      class="row-start-1 col-start-1 z-0 text-amber-50 font-serif text-center"
    >
      <!-- span class="table-font-xl">Swick</span><br / -->
      <!-- span class="table-font-lg">Knock In, Play Bold, Don't Go Set</span -->

      <!-- Show trump card during trump selection phase -->
      <div
        *ngIf="game.room!.state.trumpCard && game.trumpSelectionPhase"
        class="table-font mt-[-175px]"
      >
        <div class="flex justify-center">
          <app-card [card]="game.room!.state.trumpCard"></app-card>
        </div>
        <div class="font-bold mb-2" style="color: yellow">Trump Card</div>
      </div>

      <!-- Show visual trump card once selected -->
      <div
        *ngIf="
          game.room!.state.trumpSuit &&
          game.room!.state.trumpCard &&
          !game.trumpSelectionPhase
        "
        class="table-font mt-[-175px]"
      >
        <div class="flex justify-center">
          <app-card
            [card]="game.room!.state.trumpCard"
            class="scale-75"
          ></app-card>
        </div>
        <div class="font-bold mb-2" style="color: yellow">Trump Card</div>
      </div>
    </div>

    <div
      *ngIf="
        game.room!.state.roundState == 'idle' &&
        game.room!.state.nextRoundStartTimestamp
      "
      class="row-start-1 col-start-1 z-10 table-font-xl pill-popup"
      data-cy="roundStart-popup"
    >
      Starting round
    </div>

    <div
      *ngIf="game.trumpSelectionPhase && game.isDealer"
      class="row-start-1 col-start-1 z-10 table-font-xl pill-popup"
    >
      Do you want to Keep Trump Card?
    </div>

    <div
      *ngIf="game.knockInPhase"
      class="row-start-1 col-start-1 z-10 table-font-xl pill-popup"
    >
      <div
        *ngIf="game.room!.state.currentKnockPlayerId === game.room!.sessionId"
      >
        Your turn: Knock in to play this hand
      </div>
      <div
        *ngIf="game.room!.state.currentKnockPlayerId !== game.room!.sessionId"
      >
        Waiting for
        {{ getPlayerName(game.room!.state.currentKnockPlayerId) }} to knock
      </div>
    </div>
    <div
      *ngIf="game.room!.state.roundState === 'discard-draw'"
      class="row-start-1 col-start-1 z-10 table-font-xl pill-popup"
    >
      <div
        *ngIf="game.room!.state.currentDiscardPlayerId === game.room!.sessionId"
      >
        <div *ngIf="isDealerFinalDiscard()">
          Select 1 card to discard (cannot discard trump card)
        </div>
        <div *ngIf="!isDealerFinalDiscard()">
          Your turn: Click cards to select, then choose action
        </div>
        <div *ngIf="getSelectedCardCount() > 0" class="text-sm mt-1">
          {{ getSelectedCardCount() }} card(s) selected for discard
        </div>
      </div>
      <div
        *ngIf="game.room!.state.currentDiscardPlayerId !== game.room!.sessionId"
      >
        Waiting for
        {{ getPlayerName(game.room!.state.currentDiscardPlayerId) }} to
        discard/draw
      </div>
    </div>
    <div
      *ngIf="game.room!.state.roundState === 'turns'"
      class="row-start-1 col-start-1 z-10 table-font-xl pill-popup"
    >
      <span *ngIf="game.playersTurn">Your turn - click a card</span>
      <span *ngIf="!game.playersTurn">
        {{ getCurrentPlayerName() }}'s turn
      </span>
    </div>
    <div
      *ngIf="game.room!.state.roundState === 'trick-complete'"
      class="row-start-1 col-start-1 z-10 table-font-xl pill-popup"
    >
      Trick {{ game.room!.state.currentTrickNumber }} won by:
      {{ getTrickWinnerName() }}
    </div>

    <!-- Special Hand Announcement (similar to trick winner display) -->
    <div
      *ngIf="game.room!.state.roundState === 'special-hand-win'"
      class="absolute left-1/2 transform -translate-x-1/2 z-30"
      style="top: 25%"
    >
      <div class="special-hand-announcement text-center">
        <!-- Special Hand Title -->
        <div
          class="bg-gradient-to-r from-yellow-400 to-yellow-600 text-black font-bold text-2xl px-6 py-3 rounded-lg shadow-lg mb-4"
        >
          ğŸ† SPECIAL HAND WIN! ğŸ†
        </div>

        <!-- Winner and Hand Description -->
        <div
          class="bg-gray-900 bg-opacity-90 text-white px-6 py-4 rounded-lg shadow-xl"
        >
          <div class="text-xl font-bold mb-2">
            {{ getPlayerName(game.room!.state.specialHandWinner) }}
          </div>
          <div
            class="text-lg mb-3"
            [ngSwitch]="game.room!.state.specialHandType"
          >
            <span *ngSwitchCase="'three-aces'" class="text-red-400">
              ğŸƒ‘ ğŸƒ ğŸ‚± THREE ACES! ğŸƒ‘ ğŸƒ ğŸ‚±
            </span>
            <span *ngSwitchCase="'three-sevens'" class="text-orange-400">
              7 7 7 THREE SEVENS! 7 7 7
            </span>
            <span *ngSwitchCase="'akq-trump'" class="text-purple-400">
              ğŸ‘‘ A-K-Q OF {{ game.room!.state.trumpSuit }} ğŸ‘‘
            </span>
          </div>
          <div class="text-2xl font-bold text-green-400">
            WINS {{ game.room!.state.specialHandPotValue }}Â¢!
          </div>
          <div class="text-sm text-gray-300 mt-2">Takes the entire pot!</div>
        </div>
      </div>
    </div>

    <!-- Everyone Passed Announcement (NEW) -->
    <div
      *ngIf="shouldShowEveryonePassedMessage()"
      class="absolute left-1/2 transform -translate-x-1/2 z-30"
      style="top: 35%"
    >
      <div class="everyone-passed-announcement text-center">
        <!-- Title -->
        <div
          class="bg-gradient-to-r from-blue-500 to-blue-700 text-white font-bold text-2xl px-6 py-3 rounded-lg shadow-lg mb-4"
        >
          ğŸ† DEALER WINS! ğŸ†
        </div>

        <!-- Message -->
        <div
          class="bg-gray-900 bg-opacity-90 text-white px-6 py-4 rounded-lg shadow-xl"
        >
          <div class="text-xl font-bold text-blue-400 mb-2">
            Everyone Passed
          </div>
          <div class="text-lg text-green-400">
            {{ game.room!.state.specialRoundMessage }}
          </div>
        </div>
      </div>
    </div>

    <!-- Going Set Results Announcement (NEW) -->
    <div
      *ngIf="shouldShowGoingSetResults()"
      class="absolute left-1/2 transform -translate-x-1/2 z-30"
      style="top: 35%"
    >
      <div class="going-set-announcement text-center">
        <!-- Going Set Title -->
        <div
          class="bg-gradient-to-r from-red-500 to-red-700 text-white font-bold text-2xl px-6 py-3 rounded-lg shadow-lg mb-4"
        >
          âš ï¸ GOING SET RESULTS âš ï¸
        </div>

        <!-- Going Set Details -->
        <div
          class="bg-gray-900 bg-opacity-90 text-white px-6 py-4 rounded-lg shadow-xl"
        >
          <div *ngFor="let setPlayer of getGoingSetPlayers()" class="mb-3">
            <div class="text-lg font-bold">
              {{ setPlayer.name }}
            </div>
            <div
              class="text-md mb-1"
              [ngClass]="
                setPlayer.type === 'double' ? 'text-red-400' : 'text-orange-400'
              "
            >
              Went Set {{ setPlayer.type | titlecase }}
              <span *ngIf="setPlayer.type === 'double'">ğŸ’¸ğŸ’¸</span>
              <span *ngIf="setPlayer.type === 'single'">ğŸ’¸</span>
            </div>
            <div class="text-xl font-bold text-red-300">
              Owes {{ setPlayer.amount }}Â¢
            </div>
          </div>

          <div class="border-t border-gray-600 pt-3 mt-3">
            <div class="text-lg font-bold text-yellow-400">
              Total Bonus Next Round: {{ getTotalGoingSetBonus() }}Â¢
            </div>
            <div class="text-sm text-gray-300 mt-1">
              Only dealer pays ante next round!
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <app-player-actions
    class="sm:mt-6"
    [betMenuDisabled]="game.roundInProgress || game.player?.ready"
    [dealerHasSetAnte]="dealerHasSetAnte"
    [currentBet]="game.player?.bet || 0"
    [isDealer]="game.isDealer"
    (changeBet)="game.changeBet($event)"
    (setBet)="game.setBet($event)"
    [readyMenuHidden]="game.roundInProgress"
    [ready]="game.player?.ready"
    (readyChange)="game.setReadyState($event)"
    [autoReady]="game.player?.autoReady"
    (autoReadyChange)="game.setAutoReadyState($event)"
    [cardPlayPhase]="game.room!.state.roundState === 'turns'"
    [trumpSelectionMenuVisible]="game.trumpSelectionPhase && game.isDealer"
    [trumpCardDisplay]="getTrumpCardDisplay()"
    (keepTrump)="game.keepTrump($event)"
    [knockInMenuVisible]="
      game.knockInPhase &&
      !game.player?.hasKnockDecision &&
      game.room!.state.currentKnockPlayerId === game.room!.sessionId
    "
    [trumpSuit]="game.room!.state.trumpSuit"
    (knockIn)="game.knockIn($event)"
    [discardDrawMenuVisible]="
      game.room!.state.roundState === 'discard-draw' &&
      game.room!.state.currentDiscardPlayerId === game.room!.sessionId
    "
    [selectedCardCount]="getSelectedCardCount()"
    (playCards)="game.playCards()"
    (discardDraw)="game.discardDraw()"
    [dealerKeptTrump]="game.room!.state.dealerKeptTrump"
    [dealerTrumpValue]="game.room!.state.dealerTrumpValue"
    [isDealerFinalDiscard]="isDealerFinalDiscard()"
    (dealerGoSet)="game.dealerGoSet($event)"
    [hasGoingSetBonus]="getNextRoundBonus() > 0"
    [goingSetBonusAmount]="getNextRoundBonus()"
    [cardPlayPhase]="game.room!.state.roundState === 'turns'"
    [isPlayersTurn]="game.playersTurn"
  ></app-player-actions>

  <span class="text-neutral-400 self-end" data-cy="roomId-value">
    Room ID: {{ game.room!.id }}
  </span>
</div>
